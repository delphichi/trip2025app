<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶æ—å¿«æ¨‚ä¹‹æ—…</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#7CFC00">
</head>
<body>

    <header class="app-header">
        <h1>2025 å¹´ VIÃ‘A / CHILLAN å¿«æ¨‚ä¹‹æ—…</h1>
        <p class="subtitle">8 å¤© 7 å¤œ å®¶æ—å°ˆå±¬è¡Œç¨‹</p>
    </header>

    <main class="trip-schedule" id="trip-schedule-container">
        <h2>æ­£åœ¨è¼‰å…¥æœ€æ–°çš„å®¶æ—è¡Œç¨‹è¡¨...</h2>
    </main>
    
    <script>
        // *** æ­¥é©Ÿ 1: è¨­å®šæ‚¨çš„ Apps Script API é€£çµ ***
        const API_URL = 'https://script.google.com/macros/s/AKfycbzEf0mvIlEQI1pVBALtUz5kr2l9Q08P2z4aiZyES__a3Sl0KMswKHbyq2bf83WTkYeA5g/exec'; 

        // ==========================================================
        // æ—¥æœŸæ ¼å¼åŒ–å·¥å…·å‡½æ•¸ (è§£æ±º T03:00:00.000Z æ ¼å¼å•é¡Œ)
        // ==========================================================
        function formatDisplayDate(isoDateString) {
            if (!isoDateString) return 'æ—¥æœŸæœªå®š';
            
            // å˜—è©¦è§£æ ISO æ ¼å¼æ—¥æœŸå­—ä¸²
            const date = new Date(isoDateString);
            
            if (isNaN(date.getTime())) { // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ—¥æœŸæ™‚é–“
                return isoDateString; 
            }

            // ä½¿ç”¨æœ¬åœ°åŒ–æ ¼å¼ï¼Œè®“ç€è¦½å™¨è‡ªå‹•è™•ç†æ™‚å€å·®ç•°
            const options = { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric'
            };
            
            try {
                // ä½¿ç”¨ä¸­æ–‡ (zh-TW) æ ¼å¼é¡¯ç¤ºæ—¥æœŸ
                return new Intl.DateTimeFormat('zh-TW', options).format(date);
            } catch (e) {
                // å‚™ç”¨æ ¼å¼
                return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
            }
        }

        // ==========================================================
        // è³‡æ–™è™•ç†ï¼šå°‡æ‰å¹³çš„è©¦ç®—è¡¨è³‡æ–™ä¾ã€Œæ—¥æœŸã€åˆ†çµ„
        // ==========================================================
        function groupDataByDay(data) {
            const grouped = {};
            data.forEach(item => {
                const dayKey = item.DATE || item.DAY; 
                if (!dayKey) return; 

                if (!grouped[dayKey]) {
                    grouped[dayKey] = {
                        day: item.DAY,
                        date: item.DATE,
                        activities: []
                    };
                }
                grouped[dayKey].activities.push(item);
            });
            return Object.values(grouped);
        }

        // ==========================================================
        // ä»‹é¢ç”Ÿæˆï¼šæ ¹æ“šåˆ†çµ„å¾Œçš„è³‡æ–™ç”Ÿæˆ HTML çµæ§‹
        // ==========================================================
        function generateDayCardHTML(groupedData) {
            let htmlContent = '';
            
            groupedData.forEach(dayGroup => {
                let activitiesHtml = '';
                const displayDate = formatDisplayDate(dayGroup.date);
                
                dayGroup.activities.forEach(item => {
                    // è¡Œç¨‹æ´»å‹•å¡ç‰‡
                    if (item.Activity) {
                        activitiesHtml += `
                            <div class="activity">
                                <span class="time">${item.TIME || 'è¡Œç¨‹'}</span>
                                <p>
                                    <strong>${item.Activity}</strong> 
                                    ${item.Description ? `- ä»‹ç´¹ï¼š${item.Description}` : ''}
                                </p>
                            </div>
                        `;
                    }

                    // é¤é£²å¡ç‰‡ (ä¸­é¤)
                    if (item.LUNCH) {
                        activitiesHtml += `
                            <div class="activity meal">
                                <span class="time">ä¸­é¤</span>
                                <p>${item.LUNCH}</p>
                            </div>
                        `;
                    }
                    
                    // é¤é£²å¡ç‰‡ (æ™šé¤)
                    if (item.DINNER) {
                        activitiesHtml += `
                            <div class="activity meal">
                                <span class="time">æ™šé¤</span>
                                <p>${item.DINNER}</p>
                            </div>
                        `;
                    }
                });
                
                // æ¯å€‹æ—¥æœŸçš„ä¸»å¡ç‰‡
                htmlContent += `
                    <section class="day-card">
                        <h2 class="day-title">
                            ğŸ“† ç¬¬ ${dayGroup.day || '?'} å¤©ï¼š${displayDate}
                        </h2>
                        <div class="activity-list">
                            ${activitiesHtml}
                        </div>
                    </section>
                `;
            });
            
            return htmlContent;
        }

        // ==========================================================
        // ä¸»è¦åŸ·è¡Œï¼šæŠ“å–è³‡æ–™èˆ‡æ¸²æŸ“
        // ==========================================================
        async function fetchTripData() {
            const container = document.getElementById('trip-schedule-container');
            
            // æ­¥é©Ÿ A: å¼·åˆ¶ç§»é™¤èˆŠçš„ Service Worker è¨»å†Š (è§£æ±ºå¿«å–æ®˜ç•™å•é¡Œ)
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    for (const registration of registrations) {
                        registration.unregister();
                    }
                });
                // æ­¥é©Ÿ B: è¨»å†Šæ–°çš„ Service Worker ä¸¦åŠ å…¥æ™‚é–“æˆ³è¨˜ (è‡ªå‹•æ›´æ–°)
                const versionBuster = Date.now(); 
                navigator.serviceWorker.register('./sw.js?v=' + versionBuster);
            }

            try {
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`API é€£ç·šæˆåŠŸï¼Œä½†ç‹€æ…‹ç¢¼éŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json(); 
                container.innerHTML = ''; // æ¸…ç©ºè¼‰å…¥ä¸­æç¤º

                if (Array.isArray(data) && data.length > 0) {
                    const groupedData = groupDataByDay(data);
                    container.innerHTML = generateDayCardHTML(groupedData);
                    container.innerHTML += '<p class="footer-note">ğŸ¥³ æœ€æ–°è¡Œç¨‹è³‡æ–™å·²å¾ Google è©¦ç®—è¡¨è¼‰å…¥ï¼</p>';
                } else {
                    container.innerHTML = '<p class="footer-note">ğŸ¥³ é€£ç·šæˆåŠŸï¼Œä½†è©¦ç®—è¡¨ä¸­æ²’æœ‰æ‰¾åˆ°ä»»ä½•è¡Œç¨‹æ•¸æ“šã€‚</p>';
                }

            } catch (error) {
                console.error('Fetch error:', error);
                // é¡¯ç¤ºè©³ç´°éŒ¯èª¤è¨Šæ¯
                container.innerHTML = `
                    <p style="color: red; padding: 20px;">
                        âš ï¸ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥ API ç¶²å€æˆ–è©¦ç®—è¡¨æ¬„ä½åç¨±ã€‚
                        <br>
                        éŒ¯èª¤è©³æƒ…: ${error.message}
                    </p>`;
            }
        }

        window.addEventListener('load', fetchTripData);
    </script>
    
</body>
</html>
