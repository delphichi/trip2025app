<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶æ—å¿«æ¨‚ä¹‹æ—…</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#7CFC00">
</head>
<body>

    <header class="app-header">
        <h1>2025 å¹´ VIÃ‘A / CHILLAN å¿«æ¨‚ä¹‹æ—…</h1>
        <p class="subtitle">8 å¤© 7 å¤œ å®¶æ—å°ˆå±¬è¡Œç¨‹</p>
    </header>

    <main class="trip-schedule" id="trip-schedule-container">
        <h2>æ­£åœ¨è¼‰å…¥æœ€æ–°çš„å®¶æ—è¡Œç¨‹è¡¨...</h2>
        <p>å¦‚æœé•·æ™‚é–“æœªé¡¯ç¤ºå…§å®¹ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Apps Script é€£çµã€‚</p>
    </main>
    
    <script>
        // *** æ­¥é©Ÿ 1: è¨­å®šæ‚¨çš„ Apps Script API é€£çµ ***
        const API_URL = 'https://script.google.com/macros/s/AKfycbzEf0mvIlEQI1pVBALtUz5kr2l9Q08P2z4aiZyES__a3Sl0KMswKHbyq2bf83WTkYeA5g/exec'; 
function formatDisplayDate(isoDateString) {
    if (!isoDateString) return 'æ—¥æœŸæœªå®š';
    
    // å˜—è©¦è§£æ Apps Script å‚³ä¾†çš„ ISO æ ¼å¼æ—¥æœŸå­—ä¸²
    const date = new Date(isoDateString);
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆçš„æ—¥æœŸ
    if (isNaN(date)) {
        return isoDateString; // å¦‚æœè§£æå¤±æ•—ï¼Œå‰‡é¡¯ç¤ºåŸå§‹å­—ä¸²
    }

    // ä½¿ç”¨ Intl.DateTimeFormat é€²è¡Œæœ¬åœ°åŒ–æ ¼å¼åŒ– (ä¾‹å¦‚ï¼š2025å¹´11æœˆ30æ—¥)
    // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨ 'UTC' é¿å…ç€è¦½å™¨è‡ªå‹•èª¿æ•´æ™‚å€å°è‡´æ—¥æœŸéŒ¯èª¤
    const options = { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric',
        timeZone: 'UTC' 
    };
    
    try {
        // ä½¿ç”¨ä¸­æ–‡ (zh-TW) æ ¼å¼é¡¯ç¤ºæ—¥æœŸ
        return new Intl.DateTimeFormat('zh-TW', options).format(date);
    } catch (e) {
        // ä½œç‚ºå‚™ç”¨ï¼Œå¦‚æœ Intl ç„¡æ•ˆ
        return `${date.getFullYear()}å¹´${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
    }
}


// --------------------------------------------------------------------------
// generateDayCardHTML å‡½æ•¸ (åªä¿®æ”¹æ—¥æœŸé¡¯ç¤ºéƒ¨åˆ†)
// --------------------------------------------------------------------------
function generateDayCardHTML(groupedData) {
    let htmlContent = '';
    
    groupedData.forEach(dayGroup => {
        let activitiesHtml = '';
        // ... (activitiesHtml çš„ç”Ÿæˆé‚è¼¯ä¿æŒä¸è®Š) ...

        // æ ¼å¼åŒ–æ—¥æœŸï¼šä½¿ç”¨æ–°çš„ formatDisplayDate å‡½æ•¸ä¾†è™•ç† dayGroup.date
        const displayDate = formatDisplayDate(dayGroup.date);
        
        // æ¯å€‹æ—¥æœŸçš„ä¸»å¡ç‰‡
        htmlContent += `
            <section class="day-card">
                <h2 class="day-title">
                    ğŸ“† ç¬¬ ${dayGroup.day || '?'} å¤©ï¼š${displayDate}
                </h2>
                <div class="activity-list">
                    ${activitiesHtml}
                </div>
            </section>
        `;
    });
    
    return htmlContent;
}
        // ==========================================================
        // è³‡æ–™è™•ç†ï¼šå°‡æ‰å¹³çš„è©¦ç®—è¡¨è³‡æ–™ä¾ã€Œå¤©æ•¸ã€æˆ–ã€Œæ—¥æœŸã€åˆ†çµ„
        // ==========================================================
        function groupDataByDay(data) {
            const grouped = {};
            data.forEach(item => {
                // ä½¿ç”¨ DATE æ¬„ä½ä½œç‚ºåˆ†çµ„éµ (ç¢ºä¿å…¶å­˜åœ¨ä¸”å”¯ä¸€)
                const dayKey = item.DATE || item.DAY; 
                if (!dayKey) return; 

                if (!grouped[dayKey]) {
                    grouped[dayKey] = {
                        day: item.DAY,
                        date: item.DATE,
                        activities: []
                    };
                }
                grouped[dayKey].activities.push(item);
            });
            return Object.values(grouped);
        }

        // ==========================================================
        // ä»‹é¢ç”Ÿæˆï¼šæ ¹æ“šåˆ†çµ„å¾Œçš„è³‡æ–™ç”Ÿæˆ HTML çµæ§‹
        // ==========================================================
        function generateDayCardHTML(groupedData) {
            let htmlContent = '';
            
            groupedData.forEach(dayGroup => {
                let activitiesHtml = '';
                
                dayGroup.activities.forEach(item => {
                    // *** ç¢ºä¿é€™è£¡ä½¿ç”¨çš„å±¬æ€§åç¨±èˆ‡ Google Sheet æ¬„ä½åç¨±å®Œå…¨åŒ¹é… (ä¾‹å¦‚ï¼šitem.Activity) ***
                    
                    // è¡Œç¨‹æ´»å‹•å¡ç‰‡
                    if (item.Activity) {
                        activitiesHtml += `
                            <div class="activity">
                                <span class="time">${item.TIME || 'è¡Œç¨‹'}</span>
                                <p>
                                    <strong>${item.Activity}</strong> 
                                    ${item.Description ? `- ä»‹ç´¹ï¼š${item.Description}` : ''}
                                </p>
                            </div>
                        `;
                    }

                    // é¤é£²å¡ç‰‡ (ä¸­é¤)
                    if (item.LUNCH) {
                        activitiesHtml += `
                            <div class="activity meal">
                                <span class="time">ä¸­é¤</span>
                                <p>${item.LUNCH}</p>
                            </div>
                        `;
                    }
                    
                    // é¤é£²å¡ç‰‡ (æ™šé¤)
                    if (item.DINNER) {
                        activitiesHtml += `
                            <div class="activity meal">
                                <span class="time">æ™šé¤</span>
                                <p>${item.DINNER}</p>
                            </div>
                        `;
                    }
                });
                
                // æ¯å€‹æ—¥æœŸçš„ä¸»å¡ç‰‡
                htmlContent += `
                    <section class="day-card">
                        <h2 class="day-title">
                            ğŸ“† ç¬¬ ${dayGroup.day || '?'} å¤©ï¼š${dayGroup.date || 'æ—¥æœŸæœªå®š'}
                        </h2>
                        <div class="activity-list">
                            ${activitiesHtml}
                        </div>
                    </section>
                `;
            });
            
            return htmlContent;
        }

        // ==========================================================
        // ä¸»è¦åŸ·è¡Œï¼šæŠ“å–è³‡æ–™èˆ‡æ¸²æŸ“
        // ==========================================================
        async function fetchTripData() {
            const container = document.getElementById('trip-schedule-container');
            if ('serviceWorker' in navigator) {
    // æª¢æŸ¥æ˜¯å¦æœ‰èˆŠçš„ Service Worker è¨»å†Š
    navigator.serviceWorker.getRegistrations().then(registrations => {
        for (const registration of registrations) {
            // å¼·åˆ¶è§£é™¤å®‰è£èˆŠçš„ Service Worker
            registration.unregister().then(success => {
                if(success) {
                    console.log('Successfully unregistered old Service Worker.');
                }
            });
        }
    });
}
            // PWA Service Worker è‡ªå‹•æ›´æ–°è¨»å†Š (é¿å…å¿«å–å•é¡Œ)
            if ('serviceWorker' in navigator) {
                const versionBuster = Date.now(); 
                navigator.serviceWorker.register('./sw.js?v=' + versionBuster);
            }

            try {
                // å˜—è©¦å¾ Apps Script ç²å– JSON è³‡æ–™
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    // å¦‚æœ HTTP ç‹€æ…‹ç¢¼ä¸æ˜¯ 200 (æˆåŠŸ)ï¼Œæ‹‹å‡ºéŒ¯èª¤
                    throw new Error(`API é€£ç·šæˆåŠŸï¼Œä½†ç‹€æ…‹ç¢¼éŒ¯èª¤: ${response.status}`);
                }
                
                const data = await response.json(); 
                container.innerHTML = ''; // æ¸…ç©ºè¼‰å…¥ä¸­æç¤º

                if (Array.isArray(data) && data.length > 0) {
                    const groupedData = groupDataByDay(data);
                    container.innerHTML = generateDayCardHTML(groupedData);
                    container.innerHTML += '<p class="footer-note">ğŸ¥³ æœ€æ–°è¡Œç¨‹è³‡æ–™å·²å¾ Google è©¦ç®—è¡¨è¼‰å…¥ï¼</p>';
                } else {
                    container.innerHTML = '<p class="footer-note">ğŸ¥³ é€£ç·šæˆåŠŸï¼Œä½†è©¦ç®—è¡¨ä¸­æ²’æœ‰æ‰¾åˆ°ä»»ä½•è¡Œç¨‹æ•¸æ“šã€‚</p>';
                }

            } catch (error) {
                console.error('Fetch error:', error);
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ï¼Œé¿å…ä¸€ç‰‡ç©ºç™½
                container.innerHTML = `
                    <p style="color: red; padding: 20px;">
                        âš ï¸ è³‡æ–™è¼‰å…¥å¤±æ•—ï¼è«‹æª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š
                        <ul>
                            <li>API ç¶²å€æ˜¯å¦æ­£ç¢ºè²¼ä¸Šï¼Ÿ</li>
                            <li>Apps Script çš„å­˜å–æ¬Šæ˜¯å¦è¨­ç‚ºã€Œä»»ä½•äººã€ï¼Ÿ</li>
                            <li>è©¦ç®—è¡¨æ¬„ä½åç¨±æ˜¯å¦èˆ‡ç¨‹å¼ç¢¼ï¼ˆä¾‹å¦‚ item.DAYï¼‰å®Œå…¨åŒ¹é…ï¼Ÿ</li>
                        </ul>
                        <br>
                        éŒ¯èª¤è©³æƒ…: ${error.message}
                    </p>`;
            }
        }

        window.addEventListener('load', fetchTripData);
    </script>
    
</body>
</html>


