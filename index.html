<script>
    // ** æ›¿æ›æˆæ‚¨åœ¨ Apps Script æ­¥é©Ÿä¸­ç²å¾—çš„ Web app URL **
    const API_URL = 'https://script.google.com/macros/s/AKfycbwU_ra-PtfwW_ABOSG1zRUXAEkGvEl6iz4-05ugijW_MUr9MkkLpJ4HH5QU0vWVGnlfSQ/exec'; 
    
    // ==========================================================
    // 1. è³‡æ–™è™•ç†ï¼šå°‡æ‰å¹³çš„è©¦ç®—è¡¨è³‡æ–™ä¾ã€Œå¤©æ•¸ã€æˆ–ã€Œæ—¥æœŸã€åˆ†çµ„
    // ==========================================================
    function groupDataByDay(data) {
        const grouped = {};
        
        data.forEach(item => {
            // ä½¿ç”¨ DAY æˆ– DATE ä½œç‚ºå”¯ä¸€çš„è­˜åˆ¥éµ (Key)
            // æ³¨æ„ï¼šé€™è£¡ä½¿ç”¨çš„å±¬æ€§åç¨±å¿…é ˆå’Œè©¦ç®—è¡¨ç¬¬ä¸€è¡Œçš„æ¬„ä½åç¨±å®Œå…¨åŒ¹é…ï¼Œä¾‹å¦‚ï¼šitem.DAY
            const dayKey = item.DATE || item.DAY; 
            
            // è·³éæ²’æœ‰å¤©æ•¸/æ—¥æœŸè³‡è¨Šçš„è³‡æ–™è¡Œ
            if (!dayKey) return; 

            // å¦‚æœè©²å¤©å°šæœªåœ¨ grouped ç‰©ä»¶ä¸­ï¼Œå‰‡åˆå§‹åŒ–ä¸€å€‹æ–°çµ„
            if (!grouped[dayKey]) {
                grouped[dayKey] = {
                    day: item.DAY,
                    date: item.DATE,
                    activities: []
                };
            }
            // å°‡ç•¶å‰è¡Œè³‡æ–™æ¨å…¥è©²å¤©çš„æ´»å‹•æ¸…å–®
            grouped[dayKey].activities.push(item);
        });
        
        // å°‡ç‰©ä»¶è½‰æ›å›é™£åˆ—ï¼Œä»¥ä¾¿éæ­·é¡¯ç¤º
        return Object.values(grouped);
    }

    // ==========================================================
    // 2. ä»‹é¢ç”Ÿæˆï¼šæ ¹æ“šåˆ†çµ„å¾Œçš„è³‡æ–™ç”Ÿæˆ HTML çµæ§‹
    // ==========================================================
    function generateDayCardHTML(groupedData) {
        let htmlContent = '';
        
        groupedData.forEach(dayGroup => {
            let activitiesHtml = '';
            
            dayGroup.activities.forEach(item => {
                // *** ç¢ºä¿é€™è£¡ä½¿ç”¨çš„å±¬æ€§åç¨± (item.Activity, item.Description, item.TIME) ***
                // *** èˆ‡æ‚¨çš„ Google Sheet æ¬„ä½åç¨±å®Œå…¨åŒ¹é… (åŒ…æ‹¬å¤§å°å¯«) ***
                
                // è¡Œç¨‹æ´»å‹•å¡ç‰‡
                if (item.Activity) {
                    activitiesHtml += `
                        <div class="activity">
                            <span class="time">${item.TIME || 'è¡Œç¨‹'}</span>
                            <p>
                                <strong>${item.Activity}</strong> 
                                ${item.Description ? `- ä»‹ç´¹ï¼š${item.Description}` : ''}
                            </p>
                        </div>
                    `;
                }

                // ä¸­é¤å¡ç‰‡ (å¦‚æœ LUNCH æ¬„ä½æœ‰å…§å®¹)
                if (item.LUNCH) {
                    activitiesHtml += `
                        <div class="activity meal">
                            <span class="time">ä¸­é¤</span>
                            <p>${item.LUNCH}</p>
                        </div>
                    `;
                }
                
                // æ™šé¤å¡ç‰‡ (å¦‚æœ DINNER æ¬„ä½æœ‰å…§å®¹)
                if (item.DINNER) {
                    activitiesHtml += `
                        <div class="activity meal">
                            <span class="time">æ™šé¤</span>
                            <p>${item.DINNER}</p>
                        </div>
                    `;
                }
                
                // å¦‚æœæ‚¨æœ‰ Accommodation/ä½å®¿ æ¬„ä½ï¼Œå¯ä»¥ç¹¼çºŒåœ¨é€™è£¡æ·»åŠ é‚è¼¯
            });
            
            // æ¯å€‹æ—¥æœŸçš„ä¸»å¡ç‰‡
            htmlContent += `
                <section class="day-card">
                    <h2 class="day-title">
                        ğŸ“† ç¬¬ ${dayGroup.day || '?'} å¤©ï¼š${dayGroup.date || 'æ—¥æœŸæœªå®š'}
                    </h2>
                    <div class="activity-list">
                        ${activitiesHtml}
                    </div>
                </section>
            `;
        });
        
        return htmlContent;
    }


    // ==========================================================
    // 3. ä¸»è¦åŸ·è¡Œï¼šæŠ“å–è³‡æ–™èˆ‡æ¸²æŸ“
    // ==========================================================
    async function fetchTripData() {
        const container = document.getElementById('trip-schedule-container');
        try {
            // è¨»å†Š Service Worker æ™‚ï¼Œåœ¨ URL å¾Œé¢åŠ ä¸Šæ™‚é–“æˆ³è¨˜ä½œç‚ºæŸ¥è©¢åƒæ•¸ (è§£æ±ºæ›´æ–°å•é¡Œ)
            const versionBuster = Date.now(); 
            navigator.serviceWorker.register('./sw.js?v=' + versionBuster);

            const response = await fetch(API_URL);
            const data = await response.json(); 

            container.innerHTML = ''; // æ¸…ç©ºè¼‰å…¥ä¸­æç¤º

            if (Array.isArray(data) && data.length > 0) {
                // å°‡æ‰å¹³è³‡æ–™åˆ†çµ„
                const groupedData = groupDataByDay(data);
                
                // ç”Ÿæˆ HTML
                container.innerHTML = generateDayCardHTML(groupedData);
                
                // åŠ ä¸Šé å°¾å‚™è¨»
                container.innerHTML += '<p class="footer-note">ğŸ¥³ æœ€æ–°è³‡æ–™å·²å¾ Google è©¦ç®—è¡¨è¼‰å…¥ï¼</p>';
                
            } else {
                 container.innerHTML = '<p class="footer-note">ğŸ¥³ è³‡æ–™è¼‰å…¥æˆåŠŸï¼ä½†è©¦ç®—è¡¨ä¸­æ²’æœ‰æ‰¾åˆ°è¡Œç¨‹æ•¸æ“šã€‚</p>';
            }

        } catch (error) {
            console.error('Error fetching data:', error);
            container.innerHTML = '<p style="color: red;">âš ï¸ ç„¡æ³•å¾ Google è©¦ç®—è¡¨è¼‰å…¥è³‡æ–™ã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ– Apps Script é€£çµã€‚</p>';
        }
    }

    window.addEventListener('load', fetchTripData);
</script>

